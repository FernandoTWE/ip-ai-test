---
import LayoutHome from '../layouts/LayoutHome.astro';
import InputIP from '../components/Funcionales/InputIP.astro';

---
<LayoutHome>
<InputIP client:Load/>  
<script>
  const consultId = generarID();

  function generarID() {
      var caracteres = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
      var idAleatorio = '';
      for (var i = 0; i < 8; i++) {
          var randomIndex = Math.floor(Math.random() * caracteres.length);
          idAleatorio += caracteres[randomIndex];
      }
      return idAleatorio;
  }

  console.log(consultId);

  document.addEventListener('DOMContentLoaded', () => {
      const sendIPToWebhook = async (ip, userType, userLanguage, consultaId) => {
          await fetch("https://webapi.procesio.app/api/webhooks/launch/62e19db0-a379-4877-9fac-e50850900ca4", {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ ip, userType, userLanguage, consulta_id: consultaId })
          });
      };

      document.getElementById('analyze-button').addEventListener('click', async () => {
          const ip = document.getElementById('ip-address').value;
          const userType = document.getElementById('user-type').value;
          const userLanguage = document.getElementById('user-language').value;
          if (!ip) {
              alert("Por favor, introduce una IP.");
              return;
          }

          document.getElementById('input-card').classList.add('hidden');
          document.getElementById('loading-message').classList.remove('hidden');

          await sendIPToWebhook(ip, userType, userLanguage, consultId);

          setTimeout(() => {
              document.getElementById('loading-message').classList.add('hidden');
              document.getElementById('result-button').classList.remove('hidden');

              const resultButton = document.querySelector('#check-result-button');
              if (resultButton) {
                  console.log("Setting href for result button");
                  resultButton.setAttribute('href', `/ip-ai-test/resultados?consulta_id=${consultId}`);
              } else {
                  console.error("Result button not found");
              }
          }, 60000); // 1 minuto
      });
  });
</script>
</LayoutHome>
